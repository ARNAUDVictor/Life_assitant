{% macro task_card(task, categories) %}
<div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 p-4 border-l-4 
            {% if task.completed %}border-green-500 opacity-75{% else %}border-primary{% endif %}
            transform hover:-translate-y-1">
    <div class="flex items-start justify-between">
        <!-- Info tâche -->
        <div class="flex-1 space-y-2">
            <div class="flex items-center space-x-3">
                <h3 class="text-lg font-semibold {% if task.completed %}line-through text-gray-500{% else %}text-gray-800{% endif %}">
                    {{ task.title }}
                </h3>
                {% if task.category %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm"
                          style="background-color: {{ task.category.color }}">
                        {{ task.category.name }}
                    </span>
                {% endif %}
            </div>
            
            <div class="flex flex-col space-y-1 text-sm text-gray-600">
                <span class="flex items-center space-x-1">
                    <i class="far fa-clock text-gray-400"></i>
                    <span>Créée le {{ task.created_at.strftime('%d/%m/%Y à %H:%M') }}</span>
                </span>
                
                {% if task.due_date %}
                    <span class="flex items-center space-x-1 {% if task.is_overdue() %}text-red-600 font-semibold{% endif %}">
                        <i class="far fa-calendar-alt {% if task.is_overdue() %}text-red-600{% else %}text-gray-400{% endif %}"></i>
                        <span>Échéance : {{ task.due_date.strftime('%d/%m/%Y à %H:%M') }}</span>
                        {% if task.is_overdue() %}
                            <span class="bg-red-500 text-white px-2 py-0.5 rounded-full text-xs ml-2">En retard !</span>
                        {% endif %}
                    </span>
                {% endif %}
            </div>
            
            <!-- Sous-tâches (avec spoiler) -->
            {% if task.parent_id is none and task.can_have_subtasks() %}
                {% set all_subtasks = task.subtasks.all() %}
                
                <!-- Bouton pour afficher/cacher les sous-tâches -->
                {% if all_subtasks %}
                    <div class="mt-3">
                        <button onclick="toggleSubtasks{{ task.id }}()" 
                                class="flex items-center space-x-2 text-sm font-medium text-gray-700 hover:text-primary transition">
                            <i id="icon-subtasks-{{ task.id }}" class="fas fa-chevron-right transition-transform"></i>
                            <span>
                                <i class="fas fa-list-ul mr-1"></i>
                                Sous-tâches
                            </span>
                            {% set completed_count = all_subtasks|selectattr('completed')|list|length %}
                            <span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">
                                {{ completed_count }}/{{ all_subtasks|length }}
                            </span>
                            <!-- Mini barre de progression dans le bouton -->
                            {% set progress = (completed_count / all_subtasks|length * 100)|int %}
                            <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                <div class="bg-green-500 h-1.5 rounded-full transition-all" style="width: {{ progress }}%"></div>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Contenu des sous-tâches (caché par défaut) -->
                    <div id="subtasks-{{ task.id }}" class="hidden mt-3 pt-3 border-t border-gray-200">
                        <!-- Barre de progression complète -->
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                            {% set progress = (completed_count / all_subtasks|length * 100)|int %}
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: {{ progress }}%"></div>
                        </div>
                        
                        <!-- Liste des sous-tâches -->
                        <div class="space-y-2">
                            {% for subtask in all_subtasks %}
                                <div class="flex items-start space-x-2 ml-4">
                                    <!-- Checkbox -->
                                    <a href="{{ url_for('tasks.mark_task_complete', task_id=subtask.id) }}"
                                       class="mt-1 flex-shrink-0">
                                        <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center hover:border-primary transition
                                                    {% if subtask.completed %}bg-green-500 border-green-500{% endif %}">
                                            {% if subtask.completed %}
                                                <i class="fas fa-check text-white text-xs"></i>
                                            {% endif %}
                                        </div>
                                    </a>
                                    
                                    <!-- Contenu sous-tâche -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <p class="text-sm {% if subtask.completed %}line-through text-gray-400{% else %}text-gray-700{% endif %}">
                                                {{ subtask.title }}
                                            </p>
                                            {% if subtask.category %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold text-white"
                                                      style="background-color: {{ subtask.category.color }}">
                                                    {{ subtask.category.name }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        {% if subtask.due_date %}
                                            <p class="text-xs text-gray-500 mt-1">
                                                <i class="far fa-calendar-alt mr-1"></i>
                                                {{ subtask.due_date.strftime('%d/%m/%Y à %H:%M') }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Bouton supprimer -->
                                    <a href="{{ url_for('tasks.delete_task', task_id=subtask.id) }}"
                                       onclick="return confirm('Supprimer cette sous-tâche ?')"
                                       class="text-red-500 hover:text-red-700 transition flex-shrink-0"
                                       title="Supprimer">
                                        <i class="fas fa-times text-sm"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <script>
                        function toggleSubtasks{{ task.id }}() {
                            const content = document.getElementById('subtasks-{{ task.id }}');
                            const icon = document.getElementById('icon-subtasks-{{ task.id }}');
                            content.classList.toggle('hidden');
                            icon.classList.toggle('rotate-90');
                        }
                    </script>
                {% endif %}
                
                <!-- Bouton pour ajouter une sous-tâche (toujours visible) -->
                <div class="mt-3">
                    <button onclick="toggleSubtaskForm{{ task.id }}()" 
                            class="text-sm text-primary hover:text-secondary font-medium transition">
                        <i class="fas fa-plus-circle mr-1"></i>
                        Ajouter une sous-tâche
                    </button>
                    
                    <!-- Formulaire d'ajout (caché par défaut) -->
                    <div id="subtask-form-{{ task.id }}" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
                        <form method="POST" action="{{ url_for('tasks.add_subtask', task_id=task.id) }}" class="space-y-2">
                            <!-- Titre -->
                            <input type="text" 
                                   name="title" 
                                   placeholder="Titre de la sous-tâche..." 
                                   required 
                                   maxlength="200"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                            
                            <!-- Date et Catégorie -->
                            <div class="grid grid-cols-2 gap-2">
                                <!-- Date d'échéance -->
                                <input type="datetime-local" 
                                       name="due_date"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                                
                                <!-- Catégorie -->
                                <select name="category_id" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                                    <option value="">Sans catégorie</option>
                                    {% for cat in categories %}
                                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Boutons -->
                            <div class="flex space-x-2">
                                <button type="submit" 
                                        class="px-4 py-2 bg-primary hover:bg-secondary text-white text-sm font-medium rounded-lg transition">
                                    <i class="fas fa-plus mr-1"></i>
                                    Ajouter
                                </button>
                                <button type="button" 
                                        onclick="toggleSubtaskForm{{ task.id }}()"
                                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium rounded-lg transition">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <script>
                        function toggleSubtaskForm{{ task.id }}() {
                            const form = document.getElementById('subtask-form-{{ task.id }}');
                            form.classList.toggle('hidden');
                        }
                    </script>
                </div>
            {% endif %}
        </div>
        
        <!-- Actions -->
        <div class="flex space-x-2 ml-4">
            <a href="{{ url_for('tasks.mark_task_complete', task_id=task.id) }}"
               class="w-10 h-10 flex items-center justify-center rounded-lg transition
                      {% if task.completed %}bg-orange-500 hover:bg-orange-600{% else %}bg-green-500 hover:bg-green-600{% endif %}
                      text-white shadow-md hover:shadow-lg transform hover:scale-110"
               title="{% if task.completed %}Marquer comme non terminée{% else %}Marquer comme terminée{% endif %}">
                <i class="fas {% if task.completed %}fa-undo{% else %}fa-check{% endif %}"></i>
            </a>
            
            <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}"
               class="w-10 h-10 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow-md hover:shadow-lg transition transform hover:scale-110"
               title="Modifier">
                <i class="fas fa-edit"></i>
            </a>
            
            <a href="{{ url_for('tasks.delete_task', task_id=task.id) }}"
               onclick="return confirm('Supprimer cette tâche ?')"
               class="w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md hover:shadow-lg transition transform hover:scale-110"
               title="Supprimer">
                <i class="fas fa-trash"></i>
            </a>
        </div>
    </div>
</div>
{% endmacro %}